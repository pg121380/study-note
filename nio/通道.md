# 通道(Channel)

> 用于源节点和目标节点的连接，在java nio中主要负责缓冲区中数据的传输。通道本身不存储任何数据，需要配合缓冲区进行传输。

## 通道的主要实现类

~~~java
java.nio.channels.Channel接口
        |--FileChannel
        |--SocketChannel
        |--ServerSocketChannel
        |--DatagramChannel
~~~

## 如何获取通道

1. Java针对支持Channel的类提供了getChannel()方法

   | 本地IO | 网络IO |
   |-------|--------|
   |FileInputStream、FileOutputStream、RandomAccessFile|Socket、ServerSocket、DatagramSocket|

2. JDk1.7后提供的nio.2针对各个通道提供了静态方法open()
3. 在JDK1.7中的nio.2的Files工具类中的newByteChannel()方法

## 代码示例

1. 利用通道完成文件的复制

   ~~~java
    @Test
    public void test1() throws IOException {
        FileInputStream inputStream = new FileInputStream("H:\\IOtest\\DBUtil.java");
        FileOutputStream outputStream = new FileOutputStream("dbutil.java");

        //获取通道
        FileChannel inChannel = inputStream.getChannel();
        FileChannel outChannel = outputStream.getChannel();

        //分配缓冲区
        ByteBuffer byteBuffer = ByteBuffer.allocate(1024);

        //读写数据
        while (inChannel.read(byteBuffer) != -1){
            byteBuffer.flip();//将缓冲区切换成读数据模式（outChannel从中读取数据）
            outChannel.write(byteBuffer);
            byteBuffer.clear();//清空缓冲区
        }
        outChannel.close();
        inChannel.close();
        inputStream.close();
        outputStream.close();
    }
   ~~~

2. 使用直接缓冲区(只有ByteBuffer支持)完成文件的复制(采用内存映射文件)

   ~~~java
   @Test
    public void test2() throws IOException {
        FileChannel inChannel = FileChannel.open(Paths.get("H:\\IOtest\\DBUtil.java"), StandardOpenOption.READ);
        FileChannel outChannel = FileChannel.open(Paths.get("dbutil.java"),StandardOpenOption.WRITE,StandardOpenOption.CREATE_NEW,StandardOpenOption.READ);
        //内存映射文件(与使用allocateDirect()方法获得的缓冲区一样)
        MappedByteBuffer inMappedBuffer = inChannel.map(FileChannel.MapMode.READ_ONLY, 0, inChannel.size());
        MappedByteBuffer outMappedBuffer = outChannel.map(FileChannel.MapMode.READ_WRITE, 0, inChannel.size());

        //直接对缓冲区进行数据的读写操作
        byte[] dst = new byte[inMappedBuffer.limit()];
        inMappedBuffer.get(dst);
        outMappedBuffer.put(dst);

        inChannel.close();
        outChannel.close();
    }
   ~~~
